{"version":3,"sources":["../../src/mixins-node/get-v8-open-handles.ts"],"names":[],"mappings":"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","file":"get-v8-open-handles.js","sourcesContent":["import _ from 'lodash';\nimport asyncHooks from 'async_hooks';\n\nimport {\n  getStackTrace\n} from '../mixins/get-stack-trace';\n\nexport interface V8OpenHandle {\n  time: number;\n  asyncId: number;\n  triggerAsyncId: number;\n  resource: object;\n  executionAsyncId: number;\n  stackTrace: NodeJS.CallSite[];\n}\n\nlet _openHandles: Map<V8OpenHandle['asyncId'], V8OpenHandle>;\n\nlet _init = function(): asyncHooks.AsyncHook {\n  _openHandles = new Map();\n  let hook = asyncHooks.createHook({\n    // eslint-disable-next-line max-params\n    init: function(asyncId, type, triggerAsyncId, resource) {\n      let executionAsyncId = asyncHooks.executionAsyncId();\n      let stackTrace = getStackTrace();\n\n      // ignore ourselves\n      stackTrace.shift();\n\n      let openHandle = {\n        time: Date.now(), // not `new Date()` for performance reasons\n        asyncId,\n        type,\n        triggerAsyncId,\n        resource,\n        executionAsyncId,\n        stackTrace\n      };\n      _openHandles.set(asyncId, openHandle);\n    },\n\n    destroy: function(asyncId) {\n      if (!_openHandles.has(asyncId)) {\n        return;\n      }\n\n      _openHandles.delete(asyncId);\n    }\n  });\n\n  hook.enable();\n\n  return hook;\n};\n\n/**\n * Part of `lodash-firecloud`.\n *\n * Gets info about the V8 open handles.\n *\n * @param options Options.\n * @param [options.skipFiles] RegExps to test against when removing call sites.\n *   By default a RegExp for internal filenames is provided.\n * @returns Returns a list of V8 open handles.\n */\nexport let getV8OpenHandles = _.assign(function(options: {\n  skipFiles?: RegExp[];\n} = {}): V8OpenHandle[] {\n  _.defaults(options, {\n    skipFiles: [\n      /^internal\\//\n    ]\n  });\n\n  if (_.isUndefined(getV8OpenHandles.hook)) {\n    getV8OpenHandles.hook = _init();\n  }\n\n  let v8OpenHandles = [\n    ..._openHandles.values()\n  ];\n\n  for (let handle of v8OpenHandles) {\n    for (let skipFile of options.skipFiles) {\n      handle.stackTrace = _.filter(handle.stackTrace, function(callSite) {\n        let fileName = callSite.getFileName();\n        if (!_.isUndefined(fileName) && skipFile.test(fileName)) {\n          return false;\n        }\n        return true;\n      });\n    }\n  }\n\n  Object.defineProperty(v8OpenHandles, 'toJSON', {\n    configurable: true,\n    enumerable: false,\n    writable: false,\n\n    value: function() {\n      let entries = [];\n      for (let handle of this) {\n        let entry = _.omit(handle, [\n          'resource'\n        ]);\n\n        entry.stackTrace = _.map(entry.stackTrace, function(callSite: NodeJS.CallSite) {\n          let staticCallSite = {\n            _toString: callSite.toString(),\n\n            // this: callSite.getThis(),\n            typeName: callSite.getTypeName(),\n            // function: callSite.getFunction(),\n            functionName: callSite.getFunctionName(),\n            methodName: callSite.getMethodName(),\n            fileName: callSite.getFileName(),\n            lineNumber: callSite.getLineNumber(),\n            getColumnNumber: callSite.getColumnNumber(),\n            getEvalOrigin: callSite.getEvalOrigin(),\n            isToplevel: callSite.isToplevel(),\n            isEval: callSite.isEval(),\n            isNative: callSite.isNative(),\n            isConstructor: callSite.isConstructor(),\n            // @ts-ignore\n            isAsync: callSite.isAsync(),\n            // @ts-ignore\n            isPromiseAll: callSite.isPromiseAll(),\n            // @ts-ignore\n            getPromiseIndex: callSite.getPromiseIndex()\n          };\n\n          if (callSite.isEval()) {\n            let matched = /\\((.*):(\\d*):(\\d*)\\)/.exec(callSite.getEvalOrigin());\n            _.merge(staticCallSite, {\n              functionName: '<eval>',\n              fileName: matched[1],\n              lineNumber: matched[2]\n            });\n          }\n\n          return staticCallSite;\n        });\n\n        entries.push(entry);\n      }\n\n      return entries;\n    }\n  });\n\n  Object.defineProperty(v8OpenHandles, 'toString', {\n    configurable: true,\n    enumerable: false,\n    writable: false,\n\n    value: function() {\n      let lines = [];\n      for (let handle of this) {\n        let handleLines = [];\n        handleLines.push(new Date(handle.time).toISOString());\n        handleLines.push(_.join([\n          `${handle.type}(${handle.asyncId}):`,\n          `trigger: ${handle.triggerAsyncId},`,\n          `execution: ${handle.executionAsyncId}`\n        ], ' '));\n\n        for (let callSite of handle.stackTrace) {\n          handleLines.push(`  at ${callSite.toString()}`);\n        }\n\n        let joinedHandleLines = _.join(handleLines, '\\n');\n        lines.push(joinedHandleLines);\n      }\n\n      let joinedLines = _.join(lines, '\\n\\n');\n\n      return joinedLines;\n    }\n  });\n\n  return v8OpenHandles;\n}, {\n  hook: undefined\n});\n"]}